\documentclass[12pt]{article}

\title{Framework for Tax Preparation}
\author{Charles Duan}

\begin{document}

\maketitle

\tableofcontents

This is a software system for automating the computation and filling of tax
forms. Much like commercial software for tax preparation, the object of the
system is to allow a user to enter data from received tax forms and other
sources, and then answer interview questions, to produce completed tax forms
ready for filing.

Unlike commercial tax software, however, this system is not intended to
comprehensively cover all tax forms and options. Instead, a second object of
this system is to provide a framework to make it reasonably easy for
programming-adept users to add tax forms as necessary to their personal
situations and needs.

\section{Overview of Operation}

Use of the system proceeds in three phases.

The first phase is the computation of form values. The user enters relevant data
from received tax forms and other sources into files, and then writes a short
script that imports that data and computes the values for tax forms to be
prepared. This produces a plain text file containing the line item data to be
filled into the tax forms.

The second phase is the identification of form fields. For each tax form to be
filled in, the user provides the PDF file for the blank form and also the file
of line item data. A program displays a graphical interface where the user can
click on the blank spaces where each line item should be entered. The result of
this is a second plain text data file that lists the coordinates of each of the
form fields.

The third phase is the actual filling of the forms. The user writes another
short script that receives the data files from the first and second phases, and
places the line items from the first-phase file into the PDF form. If any
changes need to be made subsequently, the user may simply rerun the first-phase
computation script and then rerun the third-phase filling script, thereby
updating all of the tax forms automatically.


\section{Phase One: Computation}

This section describes the operation of the first phase, computation of tax form
line items.

\subsection{Structure of Tax Form Data}

The basic data structure used throughout the system is the TaxForm, which in
essence is simply a named table mapping line numbers to values. Values may be of
several types:
\begin{description}
\item[blank zero] A single dash, representing a zero value.
\item[number] A number, possibly with a decimal point and possibly led with a
minus sign.
\item[date] Formatted as mm/dd/yyyy.
\item[array] A list of values, each of which is one of the above types. Arrays
may be specified in two forms: A comma-separated list surrounded by square
brackets, or another way described below.
\item[text string] Anything else.
\end{description}
Another data type is ``boxed data,'' described below; it is represented in a
format surrounded with angle brackets and is essentially a text string or
number.

A plain text file may store one or more forms according to the following format.
A form begins with a line starting with the word ``Form'', a space, and the
name of the form. Lines of the form follow; they must be indented with
whitespace, and the line number should be separated from the value with
whitespace. For example:
\begin{quote}
\ttfamily\obeylines\obeyspaces
Form W-2
\     first\_name         John
\     last\_name          Doe
\     a                   123-45-6789
\     b                   98-7654321
\     c                   Acme Widgets Co.
\     1                   50000
\     2                   15000
\end{quote}
Further forms may be included in the same file, delineated with the start word
``Form'' at the beginning of a line.

An array may be constructed by placing each array element on a separate line in
the file, replacing the line number with a double quote mark. For example:
\begin{quote}
\ttfamily\obeylines\obeyspaces
A   15
"   18
"   20
\end{quote}
is identical to ``\texttt{A [15, 18, 20]}''.



\subsection{Special Line Names}

Generally line names in a form may be any text that has no spaces. But several
line names will receive special treatment.

\paragraph{Lines ending with an exclamation mark.} Such lines are meant for
storing metadata or informative data for a form, when there is no space for
entering the data. A common use is to create a line for transferring data to
another form. Consider, for example, a worksheet that instructs to copy line 7
to a schedule if line 7 is greater than zero, but to copy line 15 otherwise.
Instead of having to put logic into the schedule to choose between copying line
7 and line 15, the worksheet can designate a line ``fill!\@'' and the schedule
can take the value from that line.

\paragraph{Lines ending with the text ``\_explanation''.} This is for
explanations that should appear on a continuation sheet. The value should be an
array where the first item is the title of the explanation and the subsequent
items are the text of the explanation, in troff format.


\subsection{Form Submanagers}

The main FormManager for an entity may contain ``submanagers,'' namely
references to other FormManager objects for different entities or tax years.
This is a convenient way to draw information from a related filing.

Submanagers are added using the add\_submanager method, which requires a name
for identifying the submanager. Common names are :last\_year and :spouse. The
add\_submanager\_from\_file method creates a new FormManager, imports data from
the file, and adds a new submanager.


\section{Phase Two: Form Field Marking}

The program that operates this phase is ``mark\_fields.rb''. It must be supplied
with the tax form data produced in phase 1, using the ``-i'' argument. With no
further arguments, the program lists the forms for which the fields have not
been marked yet.

To mark fields in a form, enter the form name as the first non-option argument
to the command. If the form has not been marked yet, you must provide the name
of the PDF file for the form as a second command line argument.

The program will automatically save the location of the PDF file and the
coordinates of the marked fields to a file, which by default is named
``pos-data.txt''. This file name may be changed using the ``-p'' argument.




\subsection{Boxed Data}

In some cases, the PDF form will have individual boxes for each character or
portion of text, rather than a single field for all the text. The ``boxed data''
feature enables filling in these form fields correctly.

To use this feature, the relevant TaxForm should call the method
``boxed\_line(line, count, split)'' where line is the line number to be placed
in boxes, count is the number of boxes available, and split is how to separate
the line's data into segments (the default is an empty string, which means each
character is separated individually). All this does is mark the relevant line in
the form as a boxed-data line; computation proceeds unchanged.

When the form field marking program is invoked, it will detect boxed-data lines
and treat them like arrays. Thus, each box will need to be marked individually.
However, if there are more letters than boxes available, the program will
truncate data values to fit.






\section{Phase Three: Form Filling}

To fill in the forms, create a script that creates a FormManager object with the
tax forms from phase 1 imported. Then create a MultiFormManager to handle the
filling of forms. For each form to be filled in, use the fill\_form method of
the MultiFormManager.

The MultiFormManager can automatically produce continuation sheets when there is
insufficient space. This requires providing two options:
\begin{description}
\item[continuation\_bio] Biographical text for the continuation sheets, just for
identification purposes.
\item[continuation\_display] Either :show, which will print the continuation
page to the screen; :raw, which will print the raw troff code; or :append, which
will compile the troff code and append the continuation sheet to the filled tax
form.
\end{description}



\appendix


\section{Additions to Forms}

\subsection{1095-B}

This is the health coverage form. No information other than the items listed
below is needed.

\begin{description}
\item[hdhp?] Whether this plan was a high deductible plan that qualifies for HSA
contributions.
\item[coverage] ``individual'' or ``family''.
\item[months] The months of coverage for this plan. (Currently it is assumed
that all persons on the form are covered for the same months.) These should be
all-lowercase three-letter abbreviations of months.
\end{description}

\subsection{1098}

\begin{description}
\item[property] The name of the Real Estate form with which this 1098
corresponds.
\item[balance] The average mortgage balance on this loan. See Pub.\ 936.
You can compute this by averaging the balances on January 1 and December 31, or
you can multiply the interest paid by the lowest interest rate of the year.
\end{description}

\subsection{1099-DIV}

\begin{description}
\item[qualified\_exception] If this form shows qualified dividends, this flag
must be set to indicate whether an exception applies. See 1040 instructions.
\end{description}


\subsection{1099-R}

\begin{description}
\item[2b.not\_determined?] The relevant checkbox under line 2b.
\item[2b.total\_distribution?] The relevant checkbox under line 2b.
\item[ira-sep-simple?] Whether the checkbox on the form with this name is
checked.
\item[destination] Where this distribution went. It can be ``Roth conversion''
(currently the only one supported).
\end{description}


\section{Informational Forms}



\subsection{Alimony}

Alimony received. See Pub.\ 504.

\begin{description}
\item[amount] The amount of alimony received.
\end{description}


\subsection{Asset}

A form for a capitalized asset.

\begin{description}
\item[date] The date the asset was put into service.
\item[amount] The dollar value of the asset when purchased.
\item[179?] Whether the asset is a section 179 deductible asset.
\item[listed?] Whether the asset is a listed asset, see Pub.~946 chapter 5.
\item[dc\_category] The depreciation category for the asset in DC, see the FP-31
instructions, under Depreciation Guidelines.
\item[dc\_type] Choose from ``reference'', ``fixed'', or ``other'' to categorize
the asset for DC Form FP-31, lines 1--3.
\item[description] A description of the asset.
\end{description}


\subsection{Biographical}

Biographical information for an individual tax filer. Spouses should have a
separate Biographical form.

\begin{description}
\item[whose] The individual to whom this form pertains. May be ``mine'' or
``spouse''.
\item[first\_name] The first name and middle initial.
\item[last\_name] The last name.
\item[phone] Telephone number.
\item[ssn] Social Security number, with dashes.
\item[home\_address] The first line of the home address.
\item[apt\_no] The apartment number for the address.
\item[city\_zip] The city, state, and ZIP code.
\item[birthday] The person's birthday.
\item[blind?] Whether the person is blind.
\item[occupation] Your occupation
\end{description}

\subsection{Business Expense}

A deductible business expense. See IRS Pub.~535, chapter 11.

\begin{description}
\item[date] The date of the business expense.
\item[amount] The dollar amount of the expense.
\item[category] The category of expense. ``Meals'' and ``Utilities'' will
automatically be halved, the former per the IRS 50\% rule and the latter on the
assumption that 50\% of the expense was for non-business purposes. Other common
values are ``Supplies'', ``Travel'', and ``Membership''.
\item[description] A description of the expense.
\end{description}


\subsection{Charity Gift}

A charitable contribution.

\begin{description}
\item[amount] The dollar value of the contribution.
\item[cash?] Whether the contribution was in cash (as opposed to in-kind).
\item[name] The name of the charity.
\item[documented?] Whether the donation was documented. See Pub.\ 526. This is
checked if the contribution is over the \$250 threshold.
\end{description}



\subsection{Dependent}

A dependent.

\begin{description}
\item[name] The dependent's name.
\item[ssn] The dependent's social security number.
\item[relationship] The dependent's relationship with the form provider.
\item[qualifying] Whether the dependent qualifies for a tax credit. Options are
``child'' for the child tax credit, ``other'' for the credit for other
dependents, and ``none'' where the dependent is not qualifying.
\end{description}


\subsection{Estimated Tax}

Estimated tax payment made to the IRS.

\begin{description}
\item[amount] The amount of estimated tax paid.
\end{description}

\subsection{HSA Contribution}

Records of contributions to an HSA account.

\begin{description}
\item[ssn] The SSN of the beneficiary of the HSA account.
\item[contributions] Contributions made to the HSA, but not including employer
contributions or HSA/Archer MSA rollovers or HSA funding distributions.
\end{description}

\subsection{Home Office}

A portion of a home used as an office for a particular business.

\begin{description}
\item[type] The type of business associated with this home office. Currently the
only supported type is ``partnership''.
\item[ein] The EIN of the relevant business.
\item[method] Either ``simplified'' or ``actual''.
\item[sqft] Square footage of the home office area.
\item[daycare?] Whether the relevant business was a daycare.
\item[property] The name of the Real Estate form with which this home office is
associated.
\end{description}

\subsection{State Estimated Tax}

Estimated tax payment made to a state.

\begin{description}
\item[amount] The amount of estimated tax paid.
\item[state] The two-letter code for the state.
\end{description}




\subsection{State Tax}

A record of state taxes paid in the relevant tax year (usually for the previous
year). This is the amount actually paid to the state tax office, (i.e., the
amount due), not the total tax including what was already paid via withholdings.

\begin{description}
\item[amount] The amount of tax paid.
\item[name] A description (not used for computation).
\end{description}

\subsection{Traditional IRA Contribution}

A contribution to a traditional IRA.

\begin{description}
\item[amount] The amount contributed.
\item[tax\_year] The tax year of the contribution.
\item[date] The date of the contribution.
\end{description}


\subsection{Partner}

A single partner within a partnership.

\begin{description}
\item[name] The partner's name.
\item[liability] Either ``general'' or ``limited''.
\item[nationality] Either ``domestic'' or ``foreign''.
\item[type] The entity type of the partner. Currently only ``Individual'' is
supported fully. Other possibilities include ``Estate''. (This should also, in
the future, include corporations, partnerships, trusts, nonprofits, and foreign
governments, among others.)
\item[share] This partner's share of profits and losses, as a decimal fraction
such that all the partners' shares add to 1. Currently it is assumed that shares
of profits and shares of losses are equal.
\item[capital] This partner's percentage contribution of capital to the
partnership, as a decimal fraction such that all the partners' shares add to 1.
\item[ssn] The SSN of the partner.
\item[country] The country of citizenship of the partner, relevant to Form 1065
Schedule B-1, part II, column iii.
\item[address] The first line of the partner's address.
\item[address2] The second line of the partner's address.
\end{description}




\subsection{Partnership}

Biographical information for a partnership.

\begin{description}
\item[name] The name of the partnership.
\item[address] The first line of the address.
\item[address2] The second line of the address.
\item[business] The line of business of the partnership, Form 1065 line A.
\item[product] The product or service of the partnership, Form 1065 line B.
\item[code] The business code, Form 1065 line C.
\item[ein] The employer identification number of the partnership.
\item[start] The start date of the partnership.
\item[accounting] ``Cash'', ``Accrual'', or other accounting method.
\end{description}

\subsection{Real Estate}

A description of real property, used in a variety of contexts and to link other
forms that deal with a particular property.

\begin{description}
\item[property] A name for the property that will uniquely identify the property
across tax forms.
\item[basis] The basis price for the property, i.e., the purchase value. See
Pub.\ 551.
\item[sqft] The square footage of the property.
\item[purchase\_date] The date on which the property was purchased.
\end{description}




\end{document}
